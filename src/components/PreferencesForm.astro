---
const { guest } = Astro.props;
---

<div class="max-w-xl mx-auto bg-white ">
  <h2 class="text-2xl font-handwritten text-yellow-700 mb-4 text-center">
    Â¡Gracias por confirmar, {guest.name || "invitado"}!
  </h2>
  <p class="mb-6 text-gray-600 text-center">Nos gustarÃ­a conocer un poco mÃ¡s para cuidarte ese dÃ­a ðŸ¥°
    <br>
    Si tienes alguna duda, no dudes en <strong>preguntarnos</strong>!
  </p>
  <div class="space-y-5">
    <!-- Alergias -->
    <div>
      <label class="block mb-1 font-semibold text-gray-700">Â¿Tienes alguna alergia o intolerancia alimentaria? Deja vacÃ­o si no tienes ninguna</label>
      <input type="text" name="allergies" class="w-full border rounded p-2" placeholder="Ej. frutos secos, mariscoâ€¦" />
    </div>
    <!-- Dieta especial -->
    <div>
      <label class="block mb-1 font-semibold text-gray-700">Â¿Sigues alguna dieta especial? Deja vacÃ­o si no sigues ninguna</label>
      <select name="diet" class="w-full border rounded p-2">
        <option value="">-- Selecciona una opciÃ³n --</option>
        <option value="vegetariana">Vegetariana</option>
        <option value="vegana">Vegana</option>
        <option value="sin_gluten">Sin gluten</option>
        <option value="otra">Otra (especificar abajo)</option>
      </select>
    </div>
    <!-- Otra dieta -->
    <div>
      <label class="block mb-1 font-semibold text-gray-700">Otra dieta o indicaciÃ³n adicional:</label>
      <textarea name="notes" rows="2" class="w-full border rounded p-2"></textarea>
    </div>
    <!-- Participacion -->
    <div>
      <label class="block mb-1 font-semibold text-gray-700">Â¿Te gustarÃ­a ser parte de la ceremonia y dedicarnos unas palabras?</label>
      <select name="participate" class="w-full border rounded p-2">
        <option value="0">-- Selecciona una opciÃ³n --</option>
        <option value="1">SÃ­, Me encantarÃ­a! ðŸ”¥</option>
        <option value="0">No ðŸ«¢</option>
      </select>
    <button id="confirmPreferencesBtn" type="button" data-guestid={guest?.id} class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-semibold mt-2 py-2 px-4 rounded transition">
      Enviar respuestas
    </button>
  </div>
</div>

<script type="module">
    document.addEventListener("DOMContentLoaded", () => {
      const confirmBtn = document.getElementById("confirmPreferencesBtn");
  
      confirmBtn?.addEventListener("click", async () => {
        const guestId = confirmBtn.dataset.guestid;
        const allergies = document.querySelector('input[name="allergies"]').value;
        const diet = document.querySelector('select[name="diet"]').value;
        const notes = document.querySelector('textarea[name="notes"]').value;
        const participate = document.querySelector('select[name="participate"]').value === "1";

        try {
            const res = await fetch("/api/preferences", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ guestId, allergies, diet, notes, participate }),
            });

            if (res.ok) {
                window.location.href = "/guest/success-confirm";
            } else {
                alert("Hubo un error al enviar las preferencias. Por favor, intÃ©ntalo mÃ¡s tarde o contacta con nosotros ðŸ˜¢");
            }
        } catch (err) {
            console.error("Error en la solicitud: (Client layer)", err);
            alert("Error de red. Intenta mÃ¡s tarde.");
        }
      });
    });
  </script>